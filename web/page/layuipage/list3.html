<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/springmvcday02/page/layui/css/layui.css" media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
</head>
<body>
<div class="demoTable" style="margin-top: 20px">
    &nbsp; 姓名：
    <div class="layui-inline">
        <input class="layui-input" name="id" id="searchName" autocomplete="off">
    </div>
    专业：
    <div class="layui-inline">
        <input class="layui-input" name="id" id="searchMajor" autocomplete="off">
    </div>
    <button class="layui-btn" id="searchBtn" data-type="reload">搜索</button>
</div>
<script src="/springmvcday02/page/jquery/jquery-3.4.1.min.js"></script>
<table class="layui-hide" id="demo" lay-filter="test"></table>


<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" id="btn-add" lay-event="add">添加</button>
        <button class="layui-btn layui-btn-sm delAll_btn" lay-event="delete">批量删除</button>
        <button class="layui-btn layui-btn-sm" lay-event="update">编辑</button>
    </div>
</script>


<script type="text/html" id="barDemo">

    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs " lay-event="del">删除</a>
</script>


<script src="/springmvcday02/page/layui/layui.all.js" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->

<script type="text/html" id="detailForm">
    <div class="layui-form-item">
        <label class="layui-form-label">姓名:</label>
        <label class="layui-form-label"
               id="dname"
        />
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">年龄</label>
        <label class="layui-form-label"
               id="dage"
        />
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">专业</label>
        <label class="layui-form-label"
               id="dmajor"
        />
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码框</label>
        <label class="layui-form-label"
               id="dpassword"
        />
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">头像</label>
        <img class="layui-form-img" id="head" src="" style="width: 100px;height: 100px"/>

    </div>
</script>

<!--添加修改页面的脚本-->
<script type="text/html" id="updatepage">
    <form class="layui-form" lay-filter="update-form">
        <div class="layui-input-block ">
            <input type="hidden" name="user_id"
                   id="id">
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block ">
                <input type="text" name="user_name"
                       id="name"
                       required lay-verify="required" class="layui-input" style="width: 200px"
                       placeholder="请输入姓名">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">年龄</label>
            <div class="layui-input-block ">

                <input type="text" name="user_age" class="layui-input" style="width: 200px"
                       id="age"
                       required lay-verify="required"
                       placeholder="请输入姓名">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">专业</label>
            <div class="layui-input-block ">
                <input type="text" name="user_major" class="layui-input" style="width: 200px"
                       id="major"
                       required lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">地址</label>
            <div class="layui-input-block ">
                <input type="text" name="address" class="layui-input" style="width: 200px"
                       id="address"
                       required lay-verify="required"
                       placeholder="地址">
            </div>
        </div>
        <div class="layui-form-item" style="margin-top:40px">
            <div class="layui-input-block">
                <button class="layui-btn  layui-btn-submit " lay-submit=""
                        lay-filter="update-submit_btn">确认修改
                </button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>


</script>
<script>

    layui.use(['laydate', 'layer', 'jquery', 'table', 'form', "upload", "element"], function () {
        var laydate = layui.laydate //日期
            , layer = layui.layer //弹层
            , table = layui.table //表格
            , form = layui.form //滑块
            , upload = layui.upload
            , element = layui.element
            , $ = layui.jquery;


        table.render({
            elem: '#demo'
            , cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , url: 'userList2.action'
            , toolbar: '#toolbarDemo',
            page: true,
            cols:
                [[
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'user_id', title: 'ID', width: 80, sort: true}
                    , {field: 'user_name', title: '用户名'}
                    , {field: 'user_age', title: '年龄', width: 80, sort: true}
                    , {field: 'user_major', title: '专业'}
                    , {field: 'address', title: '地址'},
                    {
                        field: 'headpath',
                        title: '图片',
                        width: 80,
                        templet: '<div><img style="height:35px;width:35px;" src="/pic/{{d.headpath}}" alt=""> </div>'

                    }
                    , {fixed: 'right', width: 165, align: 'center', toolbar: '#barDemo'}
                ]],
            id: 'testReload',
            limits: [5, 15, 20, 25],
            limit: 5,
            done: function (res, curr, count) {  //回调函数解决最后一页删除跳转到前一页
                if (res.data.length == 0) {
                    table.reload('testReload', {
                        page: {
                            curr: curr - 1
                        }
                    });
                }
            }


        });
        $('#searchBtn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });


        // 点击获取数据
        var active = {
            reload: function () {

                var searchName = $('#searchName').val();
                var searchMajor = $('#searchMajor').val();
                var index = layer.msg('查询中，请稍候...', {icon: 16, time: false, shade: 0});
                setTimeout(function () {
                    table.reload('testReload', { //表格的id
                        url: 'userList2.action',
                        where: {
                            'user_name': $.trim(searchName),
                            'user_major': $.trim(searchMajor)
                        }
                    });

                }, 800);
                layer.close(index);
            },
        };


        //监听行工具事件
        table.on('tool(test)', function (obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data //获得当前行数据
                , layEvent = obj.event; //获得 lay-event 对应的值
            if (layEvent === 'upload') {
                //执行实例
                var uploadInst = upload.render({
                    elem: '#test1' //绑定元素
                    , url: '/upload/' //上传接口
                    , done: function (res) {
                        //上传完毕回调
                    }
                    , error: function () {
                        //请求异常回调
                    }
                });
            }
            if (layEvent === 'detail') {
                //弹出即全屏

                var index1 = layer.open({
                    type: 1,
                    content: $('#detailForm').html(),
                    maxmin: true
                });
                layer.full(index1);
                $("#dname").html(data.user_name);
                $("#dage").html(data.user_age);
                $("#dmajor").html(data.user_major);
                $("#head").attr("src", "/pic/" + data.headpath)
                console.log(("#head").attr("src"));

            } else if (layEvent === 'del') {
                layer.confirm('真的删除行么', function (index) {
                    $.ajax({
                        url: "delete.action",
                        data: {"user_ids": data.user_id},
                        success: function (flag) {
                            if (flag == 1) {

                                layer.msg("删除成功", {icon: 6});
                                layer.closeAll();
                                table.reload('testReload', {});
                            } else {
                                layer.msg("删除 失败", {icon: 6});
                            }

                        }
                    })

                    //向服务端发送删除指令
                });
            } else if (layEvent === 'edit') {
                var index2 = layer.open({ //打开页面
                    title: "编辑用户",
                    type: 1,
                    content: $('#updatepage').html(),
                    area: ['700px', '400px'],
                    closeBtn: 2,
                    skin: 'layui-layer-rim', //加上边框
                });

                form.val('update-form', { //填充数据
                        user_id: obj.data.user_id, //这里必须用input name属性
                        user_name: obj.data.user_name,
                        user_age: obj.data.user_age,
                        user_major: obj.data.user_major,
                        user_password: obj.data.user_password,
                        address: obj.data.address
                    }
                );
            }
        });
        form.on('submit(update-submit_btn)', function (data) {
            console.log(data);
            $.post('updateUserInfo.action', data.field, function (flag) {

                if (flag == 1) {
                    layer.msg("修改成功", {icon: 6});
                    layer.closeAll();
                    table.reload('testReload', {});
                } else {
                    layer.msg("修改失败", {icon: 6});
                }
            })
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });


        table.on('toolbar(test)', function (obj) {
                var checkStatus = table.checkStatus(obj.config.id);
                switch (obj.event) {
                    case 'add':
                        var w = ($(window).width() * 0.7);
                        var h = ($(window).height() - 50);
                        var index3 = layer.open({
                            resize: true,
                            title: '添加记录',
                            shadeClose: true,
                            area: [w + 'px', h + 'px'],
                            type: 2,
                            content: 'addUserPage.action',
                            success: function (layero, index) {
                                var body = layer.getChildFrame('body', index);
                                body.find('#content').append(editor.txt.html());
                            }
                        });
                        layer.full(index3);
                        break;
                    case 'delete':
                        var data = checkStatus.data,
                            user_ids = "";
                        if (data.length > 0) {
                            for (var i in data) {
                                user_ids += data[i].user_id + ","
                                console.log(user_ids);
                            }
                            console.log(user_ids);
                            layer.confirm('真的删除行么', function (index) {
                                $.ajax({
                                    url: "delete.action",
                                    data: {"user_ids": user_ids},
                                    success: function (flag) {
                                        if (flag > 0) {
                                            layer.msg("删除成功", {icon: 6});
                                            //layer.closeAll();
                                            table.reload('testReload', {});
                                        } else {
                                            layer.msg("删除 失败", {icon: 6});
                                        }

                                    }
                                })

                            })
                        }
                        break;
                    case
                    'update':
                        var w = ($(window).width() * 0.7);
                        var h = ($(window).height() - 50);
                        var index3 = layer.open({
                            resize: true,
                            title: '添加记录',
                            shadeClose: true,
                            area: [w + 'px', h + 'px'],
                            type: 2,
                            content: 'page/layuipage/adduser2.html',
                            success: function (layero, index) {
                                var body = layer.getChildFrame('body', index);
                                body.find('#content').append(editor.txt.html());
                            }
                        });


                        break;
                }
                ;
            }
        );

        form.on('submit(add-submit_btn)', function (data) {

            $.post('addUser.action', data.field, function (flag) {

                if (flag == 1) {

                    layer.closeAll();
                    table.reload('testReload', {});
                    layer.msg("添加成功", {icon: 6});
                } else {
                    layer.msg("添加失败", {icon: 6});
                }
            })
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        })


        form.on('submit(add-submit_btn)', function (data) {

            $.post('addUser.action', data.field, function (flag) {

                if (flag == 1) {
                    layer.closeAll();
                    table.reload('testReload', {});
                    layer.msg("添加成功", {icon: 6});
                } else {
                    layer.msg("添加失败", {icon: 6});
                }
            })
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        })


    })
    ;


</script>


</body>
</html>